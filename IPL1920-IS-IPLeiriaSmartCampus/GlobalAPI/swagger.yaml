openapi: 3.0.2
info:
  description: "Documentation for IPLeiria SmartCampus' API"
  version: "1.0.0"
  title: "IPLeiria SmartCampus"
servers:
  - url: "http://localhost/api"
tags:
- name: "api"
  description: "Information about the API"
- name: "sensors"
  description: "Information about the sensors"
- name: "locations"
  description: "Information about the locations"
- name: "readings"
  description: "Readings of a sensor or location"
- name: "alerts"
  description: "User generated alerts"
security:
- api_key: []
components:
  securitySchemes:
    api_key:
      type: "apiKey"
      name: "token"
      in: "header"
      description: "The token to access to the API (generated by the DSA)"
  schemas:
    ApiStatus:
      type: "object"
      properties:
        version:
          type: "string"
          example: "1.0.0"
    ApiError:
      type: "object"
      properties:
        error:
          type: "string"
          
    Location:
      type: "object"
      properties:
        id:
          type: "integer"
          example: 1
        name:
          type: "string"
          example: "1ยบ piso da biblioteca"
        gps_coords:
          type: "string"
          nullable: true
          example: "35.89421911 139.94637467"
          
    Sensor:
      type: "object"
      properties:
        id:
          type: "integer"
          example: 1
        user_id:
          type: "integer"
          example: null
          nullable: true
        location_id:
          type: "integer"
          example: 1
          nullable: true
          description: "If `null`, a location must be provided every time a reading is inserted"
        description:
          type: "string"
          example: "DHT"
          nullable: true
        personal:
          type: "boolean"
          example: false
        valid:
          type: "boolean"
          example: true
        fields:
          type: "array"
          items:
            $ref: "#/components/schemas/SensorField"
        date:
          type: "string"
          format: "date"
          example: "02/12/2019"
    SensorField:
      type: "object"
      properties:
        id:
          type: "number"
          format: "integer"
          example: 1
        sensor_id:
          type: "number"
          format: "integer"
          example: 1
        name:
          type: "string"
          example: "temperature"
        type:
          type: "string"
          example: "float"
          description: "Must be `float`, `int`, `string` or `bool`"
        min_value:
          type: "string"
          nullable: true
          example: "-20"
          description: "The minimum value a sensor can read; values below `min_value` will be discarded"
        max_value:
          type: "string"
          nullable: true
          example: "60"
          description: "The maximum value a sensor can read; values above `max_value` will be discarded"
    SensorData:
      type: "object"
      properties:
        id:
          type: "number"
          format: "integer"
          example: 1
        sensor_id:
          type: "number"
          format: "integer"
          example: 1
        location_id:
          type: "number"
          format: "integer"
          example: 1
        field_id:
          type: "number"
          format: "integer"
          example: 1
        value:
          type: "string"
          example: "15.6"
        valid:
          type: "boolean"
          example: true
        date:
          type: "string"
          format: "date-time"
          example: "2019-12-02T11:29:50.00Z"
    Alert:
      type: "object"
      properties:
        id:
          type: "number"
          format: "integer"
          example: 1
        sensor_id:
          type: "number"
          format: "integer"
          example: 1
        location_id:
          type: "number"
          format: "integer"
          example: 1
        user_name:
          type: "string"
          example: "John Doe"
        description:
          type: "string"
          example: "Temperature too high"
        timestamp:
          type: "string"
          format: "date-time"
          example: "2019-12-02T11:29:50.00Z"
paths:
  /:
    get:
      tags:
      - "api"
      summary: "Get the API version"
      security: []
      responses:
        "200":
          description: "Success"
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiStatus'
  
  /sensors:
    get:
      tags:
      - "sensors"
      summary: "Get all the sensors"
      responses:
        "401":
          description: "Unauthorized"
        "200":
          description: "Success"
          content:
            application/json:
              schema:
                type: "array"
                items:
                  $ref: '#/components/schemas/Sensor'
    post:
      tags:
      - "sensors"
      summary: "Add a new personal sensor"
      requestBody:
        content:
          application/json:
            schema:
              type: "object"
              properties:
                location_id:
                  type: "integer"
                  nullable: true
                  example: 1
                  description: "If `null`, a location must be provided every time a reading is inserted"
                description:
                  type: "string"
                  example: "DHT"
                fields:
                  type: "array"
                  items:
                    $ref: "#/components/schemas/SensorField"
      responses:
        "401":
          description: "Unauthorized"
        "400":
          description: "Invalid data"
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiError'
              examples:
                Invalid location:
                  value:
                    error: "Invalid location"
                Description too long:
                  value:
                    error: "Description too long; must be less than 140 characters"
                Empty fields:
                  value:
                    error: "No fields were provided"
                Empty field name:
                  value:
                    error: "Field name is required"
                Field name too long:
                  value:
                    error: "Field name too long; must be less than 32 characters"
                Empty field type:
                  value:
                    error: "Field type is required"
                Invalid field type:
                  value:
                    error: "Invalid field type; type must be float, int, string or bool"
                Invalid field range for type:
                  value:
                    error: "Invalid field range; this field type doesn't support min_value and max_value"
                Invalid field range (type mismatch):
                  value:
                    error: "Invalid field range; max_value and min_value must be the same type as type"
                Invalid field range (min_value greater than max_value):
                  value:
                    error: "Invalid field range; min_value must be less than max_value"
                Invalid field range (max_value less than min_value):
                  value:
                    error: "Invalid field range; max_value must be greater than min_value"
        "201":
          description: "Success"
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Sensor'
              example:
                id: 2
                user_id: 1
                location_id: 1
                description: "DHT"
                personal: true
                valid: true
                fields:
                  - name: "temperature"
                    type: "float"
                    min_value: "-20"
                    max_value: "60"
                date: "02/12/2019"
  /sensors/{id}:
    get:
      tags:
      - "sensors"
      summary: "Get one sensor"
      parameters:
      - name: "id"
        in: "path"
        description: "Sensor ID"
        required: true
        schema:
          type: "integer"
      responses:
        "401":
          description: "Unauthorized"
        "404":
          description: "Sensor not found"
        "200":
          description: "Success"
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Sensor'
                
  /locations:
    get:
      tags:
      - "locations"
      summary: "Get all the locations"
      responses:
        "401":
          description: "Unauthorized"
        "200":
          description: "Success"
          content:
            application/json:
              schema:
                type: "array"
                items:
                  $ref: '#/components/schemas/Location'
    post:
      tags:
      - "locations"
      summary: "Add a new location"
      requestBody:
        content:
          application/json:
            schema:
              type: "object"
              properties:
                name:
                  type: "string"
                  example: "1ยบ piso da biblioteca"
                gps_coords:
                  type: "string"
                  nullable: true
                  example: "35.89421911 139.94637467"
      responses:
        "401":
          description: "Unauthorized"
        "400":
          description: "Invalid data"
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiError'
              examples:
                Empty name:
                  value:
                    error: "Name is required"
                Name too long:
                  value:
                    error: "Name too long; must be less than 255 characters"
                Duplicate name:
                  value:
                    error: "Duplicate name; must be unique"
                Empty GPS coordinates:
                  value:
                    error: "GPS coordinates are required"
        "201":
          description: "Success"
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Location'
              example:
                id: 1
                name: "1ยบ piso da biblioteca"
                gps_coords: "35.89421911 139.94637467"
  /locations/{id}:
    get:
      tags:
      - "locations"
      summary: "Get one location"
      parameters:
      - name: "id"
        in: "path"
        description: "Location ID"
        required: true
        schema:
          type: "integer"
      responses:
        "401":
          description: "Unauthorized"
        "404":
          description: "Location not found"
        "200":
          description: "Success"
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Location'
  /readings:
    post:
      tags:
      - "readings"
      summary: "Add a new sensor reading"
      requestBody:
        content:
          application/json:
            schema:
              type: "object"
              properties:
                sensor_id:
                  type: "integer"
                  example: 1
                location_id:
                  type: "integer"
                  nullable: true
                  example: 1
                  description: "If the sensor `location_id` is `null`, a location must be provided"
                field_id:
                  type: "number"
                  format: "integer"
                  example: 1
                value:
                  type: "number"
                  format: "float"
                  example: 15.6
      responses:
        "401":
          description: "Unauthorized"
        "400":
          description: "Invalid data"
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiError'
              examples:
                Invalid sensor:
                  value:
                    error: "Invalid sensor"
                Invalid location:
                  value:
                    error: "Invalid location"
                Invalid field:
                  value:
                    error: "Invalid field"
                Sensor and field mismatch:
                  value:
                    error: "Invalid field and sensor; the sensor doesn't have the specified field"
                Empty value:
                  value:
                    error: "Value is required"
                Invalid value type:
                  value:
                    error: "Invalid value; the provided value can't be casted to the correct type"
                Invalid value range:
                  value:
                    error: "Invalid value; the provided value is not in the field range"
        "201":
          description: "Success"
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SensorData'
  /readings/{id}:
    delete:
      tags:
      - "readings"
      summary: "Invalidates a reading"
      parameters:
      - name: "id"
        in: "path"
        description: "Reading ID"
        required: true
        schema:
          type: "integer"
      responses:
        "401":
          description: "Unauthorized"
        "404":
          description: "Reading not found"
        "204":
          description: "Success"
  /readings/sensor/{id}:
    get:
      tags:
      - "readings"
      summary: "Get readings for a sensor"
      description: "This endpoint supports getting the readings between a time interval by providing a `start_date` and/or a `end_date`."
      parameters:
      - name: "id"
        in: "path"
        description: "Sensor ID"
        required: true
        schema:
          type: "integer"
      - name: "start_date"
        in: "query"
        description: "Start date (ex: 2019-12-02T11:29:50.00Z)"
        schema:
          type: "string"
          format: "date-time"
      - name: "end_date"
        in: "query"
        description: "End date (ex: 2019-12-02T11:29:50.00Z)"
        schema:
          type: "string"
          format: "date-time"
      responses:
        "401":
          description: "Unauthorized"
        "404":
          description: "Sensor not found"
        "400":
          description: "Invalid data"
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiError'
              examples:
                Invalid sensor:
                  value:
                    error: "Invalid sensor"
        "200":
          description: "Success"
          content:
            application/json:
              schema:
                type: "array"
                items:
                  $ref: "#/components/schemas/SensorData"
  /readings/sensor/{id}/latest:
    get:
      tags:
      - "readings"
      summary: "Get the latest valid sensor readings"
      parameters:
      - name: "id"
        in: "path"
        description: "Sensor ID"
        required: true
        schema:
          type: "integer"
      responses:
        "401":
          description: "Unauthorized"
        "404":
          description: "Sensor not found"
        "400":
          description: "Invalid data"
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiError'
              examples:
                Invalid sensor:
                  value:
                    error: "Invalid sensor"
        "200":
          description: "Success"
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/SensorData"
                
  /readings/location/{id}:
    get:
      tags:
      - "readings"
      summary: "Get readings for a location"
      description: "This endpoint supports getting the readings between a time interval by providing a `start_date` and/or a `end_date`."
      parameters:
      - name: "id"
        in: "path"
        description: "Location ID"
        required: true
        schema:
          type: "integer"
      - name: "start_date"
        in: "query"
        description: "Start date (ex: 2019-12-02T11:29:50.00Z)"
        schema:
          type: "string"
          format: "date-time"
      - name: "end_date"
        in: "query"
        description: "End date (ex: 2019-12-02T11:29:50.00Z)"
        schema:
          type: "string"
          format: "date-time"
      responses:
        "401":
          description: "Unauthorized"
        "404":
          description: "Location not found"
        "400":
          description: "Invalid data"
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiError'
              examples:
                Invalid location:
                  value:
                    error: "Invalid location"
        "200":
          description: "Success"
          content:
            application/json:
              schema:
                type: "array"
                items:
                  $ref: "#/components/schemas/SensorData"
  /readings/location/{id}/latest:
    get:
      tags:
      - "readings"
      summary: "Get the latest valid readings for a location"
      parameters:
      - name: "id"
        in: "path"
        description: "Location ID"
        required: true
        schema:
          type: "integer"
      responses:
        "401":
          description: "Unauthorized"
        "404":
          description: "Location not found"
        "400":
          description: "Invalid data"
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiError'
              examples:
                Invalid location:
                  value:
                    error: "Invalid location"
        "200":
          description: "Success"
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/SensorData"
                
  /alerts:
    get:
      tags:
      - "alerts"
      summary: "Get triggered user generated alerts"
      description: "This endpoint supports getting the readings between a time interval by providing a `start_date` and/or a `end_date`."
      parameters:
      - name: "start_date"
        in: "query"
        description: "Start date (ex: 2019-12-02T11:29:50.00Z)"
        schema:
          type: "string"
          format: "date-time"
      - name: "end_date"
        in: "query"
        description: "End date (ex: 2019-12-02T11:29:50.00Z)"
        schema:
          type: "string"
          format: "date-time"
      responses:
        "401":
          description: "Unauthorized"
        "200":
          description: "Success"
          content:
            application/json:
              schema:
                type: "array"
                items:
                  $ref: "#/components/schemas/Alert"
  /alerts/sensor/{id}:
    get:
      tags:
      - "alerts"
      summary: "Get triggered user generated alerts for a sensor"
      description: "This endpoint supports getting the readings between a time interval by providing a `start_date` and/or a `end_date`."
      parameters:
      - name: "id"
        in: "path"
        description: "Sensor ID"
        required: true
        schema:
          type: "integer"
      - name: "start_date"
        in: "query"
        description: "Start date (ex: 2019-12-02T11:29:50.00Z)"
        schema:
          type: "string"
          format: "date-time"
      - name: "end_date"
        in: "query"
        description: "End date (ex: 2019-12-02T11:29:50.00Z)"
        schema:
          type: "string"
          format: "date-time"
      responses:
        "401":
          description: "Unauthorized"
        "404":
          description: "Sensor not found"
        "400":
          description: "Invalid data"
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiError'
              examples:
                Invalid sensor:
                  value:
                    error: "Invalid sensor"
        "200":
          description: "Success"
          content:
            application/json:
              schema:
                type: "array"
                items:
                  $ref: "#/components/schemas/Alert"
  /alerts/location/{id}:
    get:
      tags:
      - "alerts"
      summary: "Get triggered user generated alerts for a location"
      description: "This endpoint supports getting the readings between a time interval by providing a `start_date` and/or a `end_date`."
      parameters:
      - name: "id"
        in: "path"
        description: "Location ID"
        required: true
        schema:
          type: "integer"
      - name: "start_date"
        in: "query"
        description: "Start date (ex: 2019-12-02T11:29:50.00Z)"
        schema:
          type: "string"
          format: "date-time"
      - name: "end_date"
        in: "query"
        description: "End date (ex: 2019-12-02T11:29:50.00Z)"
        schema:
          type: "string"
          format: "date-time"
      responses:
        "401":
          description: "Unauthorized"
        "404":
          description: "Location not found"
        "400":
          description: "Invalid data"
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiError'
              examples:
                Invalid location:
                  value:
                    error: "Invalid location"
        "200":
          description: "Success"
          content:
            application/json:
              schema:
                type: "array"
                items:
                  $ref: "#/components/schemas/Alert"
